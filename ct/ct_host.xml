
<!-- 
  Please see the license.html file included with this distribution for 
  attribution and copyright information.
-->

<root>
    <windowclass name="combattracker_host" merge="join">
        <script file="ct/scripts/ct_kw.lua" />
        <sheetdata>
            <buttoncontrol name="button_global_targeting" merge="join">
                <anchored to="header_toggles" position="insidetopleft" offset="0,-3" width="35" height="32" />
            </buttoncontrol>
            <buttoncontrol name="button_global_attribute" merge="join">
                <anchored to="header_toggles" position="insidetopleft" offset="25,-3" width="35" height="32" />
            </buttoncontrol>
            <buttoncontrol name="button_global_active">
                <anchored to="header_toggles" position="insidetopleft" offset="50,-3" width="35" height="32" />
            </buttoncontrol>
            <buttoncontrol name="button_global_spacing">
                <anchored to="header_toggles" position="insidetopleft" offset="72,-3" width="35" height="32" />
            </buttoncontrol>
            <buttoncontrol name="button_global_effects">
                <anchored to="header_toggles" position="insidetopleft" offset="97,-3" width="35" height="32" />
            </buttoncontrol>
            <buttoncontrol name="button_global_units">
                <anchored to="header_toggles" position="insidetopleft" offset="122,-3" width="35" height="32" />
                <state icon="button_banner" />
				<state icon="button_banner_down" />
				<script>
					function onValueChanged()
						window.list.toggleUnits();
					end
				</script>
            </buttoncontrol>
        </sheetdata>
    </windowclass>

    <windowclass name="ct_entry" merge="join">
        <script file="ct/scripts/ct_entry_kw.lua" />
        <sheetdata>
            <!-- Buttons -->
            <button_ctentry_activateunits name="activateunits" insertbefore="activateeffects">
                <anchored merge="replace" to="rightanchor" width="35" height="32">
					<top relation="relative" />
					<right anchor="left" relation="relative" offset="5" />
				</anchored>
            </button_ctentry_activateunits>
            <button_ctentry_activateeffects name="activateeffects" merge="join">
				<anchored merge="replace" to="rightanchor" width="35" height="32">
					<top relation="relative" />
					<right anchor="left" relation="relative" offset="10" />
				</anchored>
			</button_ctentry_activateeffects>
			<button_ctentry_activatespacing name="activatespacing">
				<anchored merge="replace" to="rightanchor" width="35" height="32">
					<top relation="relative" offset="2"/>
					<right anchor="left" relation="relative" offset="10"/>
				</anchored>
			</button_ctentry_activatespacing>
			<button_ctentry_activateactive name="activateactive">
				<anchored merge="replace" to="rightanchor" width="35" height="32">
					<top relation="relative" />
					<right anchor="left" relation="relative" offset="12"/>
				</anchored>
			</button_ctentry_activateactive>
			
			<button_ctentry_activatetargeting name="activatetargeting">
				<anchored merge="replace" to="rightanchor" width="35" height="32">
					<top relation="relative"/>
					<right anchor="left" relation="relative" offset="12" />
				</anchored>
			</button_ctentry_activatetargeting>
			<button_ctentry_friendfoe name="friendfoe">
				<anchored merge="replace" to="rightanchor" width="35" height="32">
					<top relation="relative"/>
					<right anchor="left" relation="relative" offset="10" />
				</anchored>
			</button_ctentry_friendfoe>

            <!-- Offense subsection -->
            <number_ct_unitstat name="attack" source="abilities.attack">
				<anchored to="reaction" position="righthigh" offset="35,0" >
				</anchored>
				<target>attack</target>
                <defense>defense</defense>
			</number_ct_unitstat>
			<label name="attack_label">
				<anchored to="attack" position="lefthigh" offset="7,0" />
				<static textres="unit_label_attack" />
			</label>
			<number_ct_unitstat name="power" source="abilities.power">
				<anchored to="attack" position="righthigh" offset="45,0" />
				<target>power</target>
                <defense>toughness</defense>
			</number_ct_unitstat>
			<label name="power_label">
				<anchored to="power" position="lefthigh" offset="7,0" />
				<static textres="unit_label_power" />
			</label>
			<number_ct_unitstat name="morale" source="abilities.morale">
				<anchored to="power" position="righthigh" offset="45,0" />
				<target>morale</target>
			</number_ct_unitstat>
			<label name="morale_label">
				<anchored to="morale" position="lefthigh" offset="7,0" />
				<static textres="unit_label_morale" />
			</label>
			<number_ct_unitstat name="command" source="abilities.command">
				<anchored to="morale" position="righthigh" offset="44,0" />
				<target>command</target>
			</number_ct_unitstat>
			<label name="command_label">
				<anchored to="command" position="lefthigh" offset="7,0" />
				<static textres="unit_label_command" />
			</label>

			<number_ct name="defense" source="abilities.defense">
				<anchored to="command" position="righthigh" offset="40,0" />
			</number_ct>
			<label name="defense_label">
				<anchored to="defense" position="lefthigh" offset="7,0" />
				<static textres="unit_label_defense" />
			</label>
			<number_ct name="toughness" source="abilities.toughness">
				<anchored to="defense" position="righthigh" offset="42,0" />
			</number_ct>
			<label name="toughness_label">
				<anchored to="toughness" position="lefthigh" offset="7,0" />
				<static textres="unit_label_toughness" />
			</label>

            <!-- Rally button -->
            <buttoncontrol name="rally">
                <script>
					function onButtonPress()
						local node = window.getDatabaseNode()
						local rActor = ActorManager.resolveActor(node)
						rAction = {};
						rAction.modifier = DB.getValue(node, "abilities.morale", 0);
						ActionRally.performRoll(nil, rActor, rAction)
					end
				</script>
                <anchored to="toughness" position="righthigh" offset="20,0" width="60" height="20" />
                <frame name="buttonup" offset="5,5,5,5" />
				<stateframe>
					<pressed name="buttondown" offset="5,5,5,5" />
				</stateframe>
				<pressed offset="1,1" />
                <font>button-white-large</font>
                <textres>unit_tooltip_rally</textres>
				<tooltip textres="unit_tooltip_rally" />
            </buttoncontrol>
        </sheetdata>
    </windowclass>

	<windowclass name="ct_power" merge="join">
		<sheetdata>
			<string_textlistitem name="value" merge="join">
				<script>
					local fActionAbility;

					function onInit()
						if super and super.onInit then
							super.onInit()
						end
						fActionAbility = super.actionAbility;
						super.actionAbility = updatedActionAbility;
					end

					function updatedActionAbility(draginfo, rAction)
						local initialResult = fActionAbility(draginfo, rAction);
						if initialResult == false then
							return initialResult;
						end

						local rRolls = {};
						if rAction.sType == "unitsavedc" then
							local rActor = getActor();
							table.insert(rRolls, ActionUnitSave.getUnitSaveInitRoll(rActor, rAction))
        					table.insert(rRolls, ActionUnitSave.getUnitSaveDCRoll(rActor, rAction))
							ActionsManager.performMultiAction(draginfo, rActor, rRolls[2].sType, rRolls);
							super.usePower(rPower);
						end						

						return true;
					end
				</script>
			</string_textlistitem>
		</sheetdata>
	</windowclass>

    <template name="number_ct_unitstat">
        <number_ct>
			<anchored width="20" height="20" />
			<default>0</default>
			<script>
				function action(draginfo)
					local rActor = ActorManager.resolveActor(window.getDatabaseNode());
                    local rAction = {};
                    rAction.label = StringManager.capitalize(target[1]);
                    rAction.stat = target[1];
                    rAction.modifier = getValue();
                    rAction.defense = (defense or {""})[1];

                    ActionTest.performRoll(draginfo, rActor, rAction);
					return true;
				end
				
				function onDragStart(button, x, y, draginfo)
					return action(draginfo);
				end

				function onDoubleClick(x,y)
					return action();
				end
			</script>
		</number_ct>
    </template>

    <template name="button_ctentry_activateunits">
		<buttoncontrol name="activateunits">
			<anchored to="rightanchor" width="35" height="32">
				<top relation="relative"/>
				<right anchor="left" relation="relative" offset="10" />
			</anchored>
			<tooltip textres="ct_tooltip_unit" />
			<state icon="button_banner" />
			<state icon="button_banner_down" />
			<script>
				function onValueChanged()
					window.windowlist.onUnitsToggle(window);
				end
			</script>
		</buttoncontrol>
	</template>

    <!-- Inherit template to add to the script -->
    <template name="list_ctbox_host_kw">
        <list_ctbox_host name="list">
            <script file="ct/scripts/ct_kw.lua"/>
        </list_ctbox_host>
    </template>
</root>